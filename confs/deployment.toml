[server]
hostname = {{ .Values.deployment.ingress.hostName | quote }}
node_ip = "$env{NODE_IP}"
base_path = "https://$ref{server.hostname}:${carbon.management.port}"
offset = {{ .Values.deploymentToml.server.offset | quote }}

[transport.https.properties]
proxyPort = 443
server = {{ .Values.deploymentToml.transport.https.properties.server | quote }}

[transport.https.sslHostConfig.properties]
protocols={{ .Values.deploymentToml.transport.https.sslHostConfig.properties.protocols | quote }}
ciphers={{ .Values.deploymentToml.transport.https.sslHostConfig.properties.ciphers | quote }}

[super_admin]
username = {{ .Values.deploymentToml.superAdmin.username | quote }}
password = "$secret{super_admin_password}"
create_admin_account = {{ .Values.deploymentToml.superAdmin.createAdminAccount }}

[user_store]
type = {{ .Values.deploymentToml.userStore.type | quote }}

[database.identity_db]
type = {{ .Values.deploymentToml.database.identity.type | quote }}
url = {{ .Values.deploymentToml.database.identity.url | quote }}
username = {{ .Values.deploymentToml.database.identity.username | quote }}
password = "$secret{database_identity_password}"
driver = {{ .Values.deploymentToml.database.identity.driver | quote }}
{{- if .Values.deploymentToml.database.identity.poolOptions }}
[database.identity_db.pool_options]
{{- range $key, $value := .Values.deploymentToml.database.identity.poolOptions }}
{{ $key }} = {{ $value | quote }}
{{- end }}
{{- end }}

[database.shared_db]
type = {{ .Values.deploymentToml.database.shared.type | quote }}
url = {{ .Values.deploymentToml.database.shared.url | quote }}
username = {{ .Values.deploymentToml.database.shared.username | quote }}
password = "$secret{database_shared_password}"
driver = {{ .Values.deploymentToml.database.shared.driver | quote }}
{{- if .Values.deploymentToml.database.shared.poolOptions }}
[database.shared_db.pool_options]
{{- range $key, $value := .Values.deploymentToml.database.shared.poolOptions }}
{{ $key }} = {{ $value | quote }}
{{- end }}
{{- end }}

[datasource.WSO2ConsentDS]
id="WSO2CONSENT_DB"
url = {{ .Values.deploymentToml.database.consent.url | quote }}
username = {{ .Values.deploymentToml.database.consent.username | quote }}
password = "$secret{database_consent_password}"
driver = {{ .Values.deploymentToml.database.consent.driver | quote }}
jmx_enable=false
{{- if .Values.deploymentToml.database.consent.poolOptions }}
[datasource.WSO2ConsentDS.pool_options]
{{- range $key, $value := .Values.deploymentToml.database.consent.poolOptions }}
{{ $key }} = {{ $value | quote }}
{{- end }}
{{- end }}

[authentication.consent]
data_source="jdbc/WSO2CONSENT_DB"

[realm_manager]
data_source = "WSO2USER_DB"

[database.user]
type = {{ .Values.deploymentToml.database.user.type | quote }}
url = {{ .Values.deploymentToml.database.user.url | quote }}
username = {{ .Values.deploymentToml.database.user.username | quote }}
password = "$secret{database_user_password}"
driver = {{ .Values.deploymentToml.database.user.driver | quote }}
{{- if .Values.deploymentToml.database.user.poolOptions }}
[database.user.pool_options]
{{- range $key, $value := .Values.deploymentToml.database.user.poolOptions }}
{{ $key }} = {{ $value | quote }}
{{- end }}
{{- end }}

[bps_database.config]
type = {{ .Values.deploymentToml.database.bps.type | quote }}
url = {{ .Values.deploymentToml.database.bps.url | quote }}
username = {{ .Values.deploymentToml.database.bps.username | quote }}
password = "$secret{database_bps_password}"
driver = {{ .Values.deploymentToml.database.bps.driver | quote }}
{{- if .Values.deploymentToml.database.bps.poolOptions }}
[bps_database.config.pool_options]
{{- range $key, $value := .Values.deploymentToml.database.bps.poolOptions }}
{{ $key }} = {{ $value | quote }}
{{- end }}
{{- end }}

[keystore.tls]
file_name =  {{ .Values.deploymentToml.keystore.tls.fileName | quote }}
type =  {{ .Values.deploymentToml.keystore.tls.type | quote }}
password = "$secret{keystore_tls_password}"
alias = {{ .Values.deploymentToml.keystore.tls.alias | quote }}
key_password = "$secret{keystore_tls_key_password}"

[keystore.primary]
file_name =  {{ .Values.deploymentToml.keystore.primary.fileName | quote }}
type =  {{ .Values.deploymentToml.keystore.primary.type | quote }}
password = "$secret{keystore_primary_password}"
alias = {{ .Values.deploymentToml.keystore.primary.alias | quote }}
key_password = "$secret{keystore_primary_key_password}"

[keystore.internal]
file_name =  {{ .Values.deploymentToml.keystore.internal.fileName | quote }}
type =  {{ .Values.deploymentToml.keystore.internal.type | quote }}
password = "$secret{keystore_internal_password}"
alias = {{ .Values.deploymentToml.keystore.internal.alias | quote }}
key_password = "$secret{keystore_internal_key_password}"

[truststore]
file_name =  {{ .Values.deploymentToml.truststore.fileName | quote }}
type =  {{ .Values.deploymentToml.truststore.type | quote }}
password = "$secret{keystore_truststore_password}"

[account_recovery.endpoint.auth]
hash= {{ .Values.deploymentToml.account.recovery.endpoint.auth.hash | quote }}

[identity.auth_framework.endpoint]
app_password= "$secret{app_password}"


{{- if .Values.deploymentToml.clustering.enabled }}
[clustering]
membership_scheme={{.Values.deploymentToml.clustering.membershipScheme | quote }}
domain= {{.Values.deploymentToml.clustering.domain | quote }}
local_member_port={{.Values.deploymentToml.clustering.localMemberPort | quote }}
properties.KUBERNETES_NAMESPACE={{ .Release.Namespace | quote }}
properties.KUBERNETES_SERVICES={{ include "..fullname" . | quote }}
{{- end }}

[oauth.token_cleanup]
enable = {{.Values.deploymentToml.oauth.tokenCleanup }}

[oauth.token_generation]
include_username_in_access_token = {{.Values.deploymentToml.oauth.tokenGeneration.includeUsernameInAccessToken }}

# Block all unused fileupload with super tenant permissions (SECURITYINTERNAL-1738)
[[resource.access_control]]
context="(.*)/fileupload/service(.*)"
secure=true
http_method = "all"
permissions = ["/permission/admin/manage/identity/applicationmgt/create"]

[[resource.access_control]]
context="(.*)/fileupload(.*)"
secure=true
http_method = "all"
permissions = ["/permission/protected/manage/monitor/tenants"]

{{- if .Values.deploymentToml.recaptcha.enabled }}
#Google reCAPTCHA settings.

[recaptcha]
enabled = true
api_url = {{ .Values.deploymentToml.recaptcha.apiUrl | quote }}
verify_url = {{ .Values.deploymentToml.recaptcha.verifyUrl | quote }}
site_key = "$secret{recaptcha_site_key}"
secret_key = "$secret{recaptcha_secret_key}"
{{- end }}

{{- if .Values.deploymentToml.outputAdapter.email.enabled }}
# SMTP email sender settings.
[output_adapter.email]
from_address= {{ .Values.deploymentToml.outputAdapter.email.fromAddress | quote }}
username= {{ .Values.deploymentToml.outputAdapter.email.username | quote }}
password= "$secret{output_adapter_email_password}"
hostname= {{ .Values.deploymentToml.outputAdapter.email.hostname | quote }}
port= {{ .Values.deploymentToml.outputAdapter.email.port }}
enable_start_tls= {{ .Values.deploymentToml.outputAdapter.email.enableStartTls }}
enableAuthentication= {{ .Values.deploymentToml.outputAdapter.email.enableAuthentication }}
{{- end }}

# Configuring user account locking. Ref: https://is.docs.wso2.com/en/latest/guides/identity-lifecycles/lock-account/
{{- if .Values.deploymentToml.userAccountLock.enabled }}
[event.default_listener.identity_mgt]
priority= "50"
enable = false
[event.default_listener.governance_identity_mgt]
priority= "95"
enable = true

[identity_mgt.account_locking]
allowed_failed_attempts={{ .Values.deploymentToml.userAccountLock.loginAttempts.allowedFailedAttempts }}
auto_unlock_time_increment_ratio={{ .Values.deploymentToml.userAccountLock.loginAttempts.autoUnlockTimeIncrementRatio }}
auto_unlock_after={{ .Values.deploymentToml.userAccountLock.loginAttempts.autoUnlockAfter }}
enable_account_locking=true

{{- if .Values.deploymentToml.userAccountLock.otp.emailEnabled }}
[authentication.authenticator.email_otp.parameters]
EnableAccountLockingForFailedAttempts = true
{{- end }}

{{- if .Values.deploymentToml.userAccountLock.otp.smsEnabled }}
[authentication.authenticator.sms_otp.parameters]
EnableAccountLockingForFailedAttempts = true
EnableAccountLockingForFailedAttempts = true
{{- end }}

{{- if .Values.deploymentToml.userAccountLock.totpEnabled }}
[authentication.authenticator.totp.parameters]
EnableAccountLockingForFailedAttempts = true
{{- end }}

{{- end }}

{{- if .Values.deploymentToml.extraConfigs }}
{{ .Values.deploymentToml.extraConfigs }}
{{- end }}

# Secure vault encryted secrets
[secrets]
# Super admin creds
super_admin_password = {{ .Values.deploymentToml.superAdmin.encryptedPassword | quote }}
# Database creds
database_identity_password = {{ .Values.deploymentToml.database.identity.encryptedPassword | quote }}
database_shared_password = {{ .Values.deploymentToml.database.shared.encryptedPassword | quote }}
database_user_password = {{ .Values.deploymentToml.database.user.encryptedPassword | quote }}
database_consent_password = {{ .Values.deploymentToml.database.consent.encryptedPassword | quote }}
database_bps_password = {{ .Values.deploymentToml.database.bps.encryptedPassword | quote }}
# Keystores
keystore_tls_password = {{ .Values.deploymentToml.keystore.tls.encryptedPassword | quote }}
keystore_tls_key_password = {{ .Values.deploymentToml.keystore.tls.encryptedKeyPassword | quote }}
keystore_primary_password = {{ .Values.deploymentToml.keystore.primary.encryptedPassword | quote }}
keystore_primary_key_password = {{ .Values.deploymentToml.keystore.primary.encryptedKeyPassword | quote }}
keystore_internal_password = {{ .Values.deploymentToml.keystore.internal.encryptedPassword | quote }}
keystore_internal_key_password = {{ .Values.deploymentToml.keystore.internal.encryptedKeyPassword | quote }}
# Truststore
keystore_truststore_password = {{ .Values.deploymentToml.truststore.encryptedPassword | quote }}
# App password
app_password = {{ .Values.deploymentToml.identity.authFramework.endpoint.encryptedAppPassword | quote }}

{{- if .Values.deploymentToml.recaptcha.enabled }}
# Recaptcha creds
recaptcha_site_key = {{ .Values.deploymentToml.recaptcha.encryptedSiteKey | quote }}
recaptcha_secret_key = {{ .Values.deploymentToml.recaptcha.encryptedSecretKey | quote }}
{{- end }}

{{- if .Values.deploymentToml.outputAdapter.email.enabled }}
output_adapter_email_password = {{ .Values.deploymentToml.outputAdapter.email.encryptedPassword | quote }}
{{- end }}
